function escapeHTML(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function validateEmail(e){var a=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return a.test(e)}function doWordsMatch(e,a){return e===a?!0:!1}function isLongPassword(e){return e.length<MIN_PASSWORD_LENGTH?!1:!0}function isSimplePassword(e){return-1!==BAD_PASSWORDS.indexOf(e)?!0:!1}function showPanelMessage(e,a,r){r.html('<div class="alert alert-'+a+'">'+e+"</div>")}function showModalMessage(e,a,r){r.html('<div class="alert alert-'+a+'">'+e+"</div>")}function resetAddUserModal(){$("#form-new-user .username").val(""),$("#form-new-user .password1").val(""),$("#form-new-user .password2").val(""),$("#form-new-user .default").attr("checked",!0).parent("label").addClass("active").siblings("label").removeClass("active"),$(".msg").html("")}function getUsers(){var e=$(".user-list");$.ajax({type:"GET",url:"/users/get/all/",dataType:"json",beforeSend:function(){e.html('<option value="0">Loading...</option>').attr("disabled",!0)},error:function(a){e.html('<option value="0">Error (please see dev tools)</option>'),console.log(a)},success:function(a){e.html(""),e.append("<option value='0'>Please choose...</option>").attr("disabled",!1);var r=a.data;r.forEach(function(a){"administrator"!==a.username&&e.append('<option value="'+a.id+'">'+a.username+"</option>")})}})}function resetChangePwdModal(){$(".user-list").val("0"),$("#form-change-pwd .password1").val(""),$("#form-change-pwd .password2").val(""),$(".msg").html("")}function resetUpdateUserModal(){$("#form-update-user label.btn").attr("disabled",!0).removeClass("active"),$("#form-update-user input[type=radio]").attr("disabled",!0).attr("checked",!1),$(".msg").html(""),$("#update-user-submit").attr("disabled",!0)}function generateExpirationYears(){var e=$("#card-exp-year");e.html("");var a=new Date,r=a.getFullYear();e.append("<option value='0'>Please choose.</option>");for(var s=r;r+11>s;s++)e.append("<option value='"+s+"'>"+s+"</option>");console.log("Loading expiration years...done!")}function resetAddCardPanel(){$("#customer-id").val(""),$("#customer-name").val(""),$("#cardholder-name").val(""),$("#card-number").val(""),$("#card-exp-year").val("0"),$("#card-exp-month").val("0"),$("#card-cvc").val(""),$("#card-postal-code").val("")}function getCards(){var e=$("#customer-list");$.ajax({type:"GET",url:"/card/get/all/",beforeSend:function(){console.log("Loading cards..."),e.html('<option value="Loading...">')},error:function(a){console.log(a),console.log(JSON.parse(a.responseText)),e.html('<option value="Could Not Load">')},dataType:"json",success:function(a){console.log("Loading cards...done!");var r=a.data;return e.html(""),0===r.length?void e.html('<option value="None exist yet!" data-id="0">'):void r.forEach(function(a){var r=a.customer_name,s=a.id;e.append('<option value="'+r+'" data-id="'+s+'">')})}})}function getCardIdFromDataList(e){var a=e.val(),r=$("#customer-list option"),s="";return r.each(function(){var e=$(this).val(),r=$(this).data("id");return a===e?(s=r,!1):void 0}),s}function resetChargeCardPanel(e){$("#charge-card .customer-name").val("").prop("disabled",!1),$("#charge-card .customer-cardholder").val(""),$("#charge-card .card-last-four").val(""),$("#charge-card .card-expiration").val(""),$("#charge-card .charge-amount").val(""),$("#charge-card .charge-invoice").val(""),$("#charge-card .charge-po").val(""),$("#charge-card-submit").prop("disabled",!1),e&&$("#charge-card .msg").html("")}function resetChargeSuccessPanel(){$("#panel-charge-success .customer-name").text(""),$("#panel-charge-success .cardholder").text(""),$("#panel-charge-success .card-last4").text(""),$("#panel-charge-success .card-exp").text(""),$("#panel-charge-success .amount").text(""),$("#panel-charge-success .invoice").text(""),$("#panel-charge-success .po").text(""),$("#show-receipt").attr("href","")}const MIN_PASSWORD_LENGTH=8,BAD_PASSWORDS=["password","password1","12345678","123456789","123123123","00000000","1234567890","asdfasdf","asdfghjkl","testtest","admin@example.com"],MIN_CHARGE=.5;$("body").on("click",".action-btn",function(){var e=$(this),a=e.data("action");if(void 0!==e.attr("disabled"))return void console.log("btn disabled");var r=$(".action-panels.show"),s=r.attr("id");if(s!==a){var t="#"+a,o=$(t),d=$("#action-panels-container").outerWidth(),n=$(".action-btn");n.attr("disabled",!0).children("input").attr("disabled",!0),r.toggle("slide",{distance:d},600,function(){r.removeClass("show"),o.toggle("slide",600,function(){o.addClass("show"),n.attr("disabled",!1)})}),resetAddCardPanel(),resetChargeCardPanel(!0)}}),$("#create-init-admin").submit(function(e){var a=$("#password1").val(),r=$("#password2").val(),s=$("#create-init-admin .msg");return doWordsMatch(a,r)===!1?(e.preventDefault(),showPanelMessage("The passwords do not match.","danger",s),!1):isLongPassword(a)===!1?(e.preventDefault(),showPanelMessage("Your password is too short. It must be at least 8 characters.","danger",s),!1):isSimplePassword(a)===!0?(e.preventDefault(),essage("The password you provided is too simple. Please choose a better password.","danger",s),!1):void 0}),$("#form-new-user").submit(function(e){var a=$("#form-new-user .username").val(),r=$("#form-new-user .password1").val(),s=$("#form-new-user .password2").val(),t=$("#form-new-user .can-add-cards input:checked").val(),o=$("#form-new-user .can-remove-cards input:checked").val(),d=$("#form-new-user .can-charge-cards input:checked").val(),n=$("#form-new-user .can-view-reports input:checked").val(),c=$("#form-new-user .is-admin input:checked").val(),l=$("#form-new-user .is-active input:checked").val(),i=$("#form-new-user .msg"),u=$("#form-new-user-submit");return validateEmail(a)===!1?(e.preventDefault(),showModalMessage("You must provide an email address as a username.","danger",i),!1):doWordsMatch(r,s)===!1?(e.preventDefault(),showModalMessage("The passwords do not match.","danger",i),!1):isLongPassword(r)===!1?(e.preventDefault(),showModalMessage("Your password is too short. It must be at least 8 characters.","danger",i),!1):isSimplePassword(r)===!0?(e.preventDefault(),showModalMessage("Your password too simple. Choose a more complex password.","danger",i),!1):(i.html(""),e.preventDefault(),$.ajax({type:"POST",url:"/users/add/",data:{username:a,password1:r,password2:s,addCards:t,removeCards:o,chargeCards:d,reports:n,admin:c,active:l},beforeSend:function(){u.attr("disabled",!0),showModalMessage("Saving user...","info",i)},error:function(e){var a=JSON.parse(e.responseText);return a.ok===!1?(showModalMessage(a.data.error_msg,"danger",i),void console.log(a)):void u.attr("disabled",!0)},success:function(){showModalMessage("New user was saved sucessfully!","success",i),setTimeout(function(){u.attr("disabled",!1),resetAddUserModal()},3e3)}}),!1)}),$("#modal-new-user").on("hidden.bs.modal",function(){resetAddUserModal()}),$("#modal-change-pwd, #modal-update-user").on("show.bs.modal",function(){getUsers()}),$("#form-change-pwd").submit(function(e){var a=$("#form-change-pwd .user-list").val(),r=$("#form-change-pwd .password1").val(),s=$("#form-change-pwd .password2").val(),t=$("#form-change-pwd .msg"),o=$("#change-password-submit");return doWordsMatch(r,s)===!1?(e.preventDefault(),showModalMessage("The passwords do not match.","danger",t),!1):isLongPassword(r)===!1?(e.preventDefault(),showModalMessage("Your password is too short. It must be at least 8 characters.","danger",t),!1):isSimplePassword(r)===!0?(e.preventDefault(),showModalMessage("Your password too simple. Choose a more complex password.","danger",t),!1):($.ajax({type:"POST",url:"/users/change-pwd/",data:{userId:a,pass1:r,pass2:s},beforeSend:function(){o.attr("disabled",!0),showModalMessage("Saving new password...","info",t)},error:function(e){showModalMessage("An error occured while trying to update this user's password.","danger",t),console.log(e)},success:function(){showModalMessage("This user's password has been updated.","success",t),setTimeout(function(){o.attr("disabled",!1),resetChangePwdModal()},3e3)}}),e.preventDefault(),!1)}),$("#modal-change-pwd").on("hidden.bs.modal",function(){resetAddUserModal()}),$("#modal-update-user").on("hidden.bs.modal",function(){resetUpdateUserModal()}),$("#form-update-user").on("change",".user-list",function(){var e=$(this).val(),a=$("#form-update-user .msg");return 0===e?void resetUpdateUserModal():void $.ajax({type:"GET",url:"/users/get/",data:{userId:e},beforeSend:function(){resetUpdateUserModal(),showModalMessage("Retrieving user's permissions...","info",a)},error:function(e){showModalMessage("An error occured while trying to retrieve this users data. Please try again.","danger",a),console.log(e)},dataType:"json",success:function(e){a.html(""),$("#form-update-user label.btn").attr("disabled",!1),$("#form-update-user input[type=radio]").attr("disabled",!1),$("#update-user-submit").attr("disabled",!1);var r=e.data;r.add_cards?$("#form-update-user .can-add-cards input[value=true]").attr("checked",!0).parent().addClass("active"):$("#form-update-user .can-add-cards input[value=false]").attr("checked",!0).parent().addClass("active"),r.remove_cards?$("#form-update-user .can-remove-cards input[value=true]").attr("checked",!0).parent().addClass("active"):$("#form-update-user .can-remove-cards input[value=false]").attr("checked",!0).parent().addClass("active"),r.charge_cards?$("#form-update-user .can-charge-cards input[value=true]").attr("checked",!0).parent().addClass("active"):$("#form-update-user .can-charge-cards input[value=false]").attr("checked",!0).parent().addClass("active"),r.view_reports?$("#form-update-user .can-view-reports input[value=true]").attr("checked",!0).parent().addClass("active"):$("#form-update-user .can-view-reports input[value=false]").attr("checked",!0).parent().addClass("active"),r.is_admin?$("#form-update-user .is-admin input[value=true]").attr("checked",!0).parent().addClass("active"):$("#form-update-user .is-admin input[value=false]").attr("checked",!0).parent().addClass("active"),r.is_active?$("#form-update-user .is-active input[value=true]").attr("checked",!0).parent().addClass("active"):$("#form-update-user .is-active input[value=false]").attr("checked",!0).parent().addClass("active")}})}),$("#form-update-user").submit(function(e){var a=$("#form-update-user .user-list").val(),r=$("#form-update-user .can-add-cards label.active input").val(),s=$("#form-update-user .can-remove-cards label.active input").val(),t=$("#form-update-user .can-charge-cards label.active input").val(),o=$("#form-update-user .can-view-reports label.active input").val(),d=$("#form-update-user .is-admin label.active input").val(),n=$("#form-update-user .is-active label.active input").val(),c=$("#form-update-user .msg"),l=$("#update-user-submit");return 0===a.length?(e.preventDefault(),void showModalMessage("A user must be chosen first.","danger",c)):(e.preventDefault(),$.ajax({type:"POST",url:"/users/update/",data:{userId:a,addCards:r,removeCards:s,chargeCards:t,reports:o,admin:d,active:n},beforeSend:function(){l.attr("disabled",!0),showModalMessage("Saving updated permissions...","info",c)},error:function(e){var a=JSON.parse(e.responseText);return a.ok===!1?(showModalMessage(a.data.error_msg,"danger",c),void console.log(a)):void 0},dataType:"json",success:function(){showModalMessage("User updated successfully!","success",c),setTimeout(function(){l.attr("disabled",!1),c.html("")},3e3)}}),!1)}),$("#add-card").on("change","#card-exp-month",function(){var e=$(this).val(),a=new Date,r=a.getMonth()+1,s=a.getFullYear();$("#card-exp-year option[value="+s+"]").css(r>e?{display:"none"}:{display:"block"})}),$("#add-card").submit(function(e){function a(e,a){return a.error?(showPanelMessage("The credit card could not be saved. Please contact an administrator. Message: "+a.error.message+".","danger",p),void console.log(a)):void $.ajax({type:"POST",url:"/card/add/",data:{customerId:r,customerName:s,cardholder:t,cardToken:a.id,cardExp:a.card.exp_month+"/"+a.card.exp_year,cardLast4:a.card.last4},error:function(e){var a=JSON.parse(e.responseText);return console.log(a),0==a.ok?(showPanelMessage(a.data.error_msg,"danger",p),void u.prop("disabled",!1).text("Add Card")):void 0},success:function(){resetAddCardPanel(),showPanelMessage("Card was saved!","success",p),setTimeout(function(){p.html(""),u.prop("disabled",!1).text("Add Card"),getCards()},3e3)}})}var r=($("#add-card"),$("#customer-id").val().trim()),s=$("#customer-name").val().trim(),t=$("#cardholder-name").val().trim(),o=$("#card-number").val().trim().replace(" ","").replace("-",""),d=parseInt($("#card-exp-year").val()),n=parseInt($("#card-exp-month").val()),c=$("#card-cvc").val().trim(),l=$("#card-postal-code").val().trim(),i=Stripe.card.cardType(o),u=$("#add-card .submit-form-btn"),p=$("#add-card .msg");if(p.html(""),s.length<2)return e.preventDefault(),showPanelMessage("You must provide a customer name. This can be the same as the cardholder or the name of a company. This is used to lookup cards when you want to create a charge.","danger",p),!1;if(t.length<2)return e.preventDefault(),showPanelMessage("Please provide the name of the cardholder as it is given on the card.","danger",p),!1;var h=o.length;if(15>h||h>16)return e.preventDefault(),showPanelMessage("The card number you provided is "+h+" digits long, however, it must be exactly 15 or 16 digits.","danger",p),!1;if(Stripe.card.validateCardNumber(o)===!1)return e.preventDefault(),showPanelMessage("The card number you provided is not valid.","danger",p),!1;var m=new Date,g=m.getMonth()+1,v=m.getFullYear();return 0===n||"0"===n?(e.preventDefault(),showPanelMessage("Please choose the card's expiration month.","danger",p),!1):0===d||"0"===d?(e.preventDefault(),showPanelMessage("Please choose the card's expiration year.","danger",p),!1):d===v&&g>n?(e.preventDefault(),showPanelMessage("The card's expiration must be in the future.","danger",p),!1):Stripe.card.validateExpiry(n,d)===!1?(e.preventDefault(),showPanelMessage("The card's expiration must be in the future.","danger",p),!1):Stripe.card.validateCVC(c)===!1?(e.preventDefault(),showPanelMessage("The security code you provided is invalid.","danger",p),!1):"American Express"===i&&4!==c.length?(e.preventDefault(),showPanelMessage("You provided an American Express card but your security code is invalid. The security code must be exactly 4 numbers long.","danger",p),!1):"American Express"!==i&&3!==c.length?(e.preventDefault(),showPanelMessage("You provided an "+Stripe.card.cardType(o)+" card but your security code is invalid. The security code must be exactly 3 numbers long.","danger",p),!1):l.length<5||l.length>6?(e.preventDefault(),showPanelMessage("The postal code must be exactly 5 numeric or 6 alphanumeric characters.","danger",p),!1):(u.prop("disabled",!0),showPanelMessage("Saving card...","info",p),Stripe.card.createToken({name:t,number:o,cvc:c,exp_month:n,exp_year:d,address_zip:l},a),e.preventDefault(),!1)}),$("#add-card").on("click",".clear-form-btn",function(){resetAddCardPanel()}),$("#remove-card").submit(function(e){var a=$("#remove-card .customer-name"),r=a.val(),s=getCardIdFromDataList(a),t=$("#remove-card .submit-form-btn"),o=$("#remove-card .msg");return 0===s||"0"===s||0===s.length?(e.preventDefault(),showPanelMessage("You must choose a customer.","danger",o),console.log("input val: "+a.val()),console.log("cust id: "+s),void console.log("cust id length: "+s.length)):($.ajax({type:"POST",url:"/card/remove/",data:{customerId:s,customerName:r},beforeSend:function(){t.prop("disabled",!0),showPanelMessage("Removing card...","info",o)},error:function(e){var a=JSON.parse(e.responseText);return a.ok===!1?(t.prop("disabled",!1),showPanelMessage("An error occured while removing this card. Please contact an administrator.","danger",o),void console.log(a)):void 0},dataType:"json",success:function(){t.prop("disabled",!1),showPanelMessage("Card was removed!","success",o),a.val(""),setTimeout(function(){getCards(),o.html("")},3e3)}}),e.preventDefault(),!1)}),$("#charge-card").on("change",".customer-name",function(){var e=$("#charge-card .customer-name"),a=getCardIdFromDataList(e),r=$("#charge-card .msg");return r.html(""),""===a?void showPanelMessage("The customer name you provided is not a real customer. Please choose a customer from the list.","danger",r):void $.ajax({type:"GET",url:"/card/get/",data:{customerId:a},beforeSend:function(){$("#charge-card .customer-cardholder").val("Loading..."),$("#charge-card .card-last-four").val("Loading..."),$("#charge-card .card-expiration").val("Loading...")},error:function(e){var a=JSON.parse(e.responseText);showPanelMessage(a.data.error_msg,"danger",r),console.log(e)},dataType:"json",success:function(e){var a=e.data;$("#charge-card .customer-cardholder").val(a.cardholder_name),$("#charge-card .card-last-four").val(a.card_last4),$("#charge-card .card-expiration").val(a.card_expiration),$("#charge-card .charge-amount").prop("disabled",!1),$("#charge-card .charge-invoice").prop("disabled",!1),$("#charge-card .charge-po").prop("disabled",!1)}})}),$("#charge-card").submit(function(e){var a=$("#charge-card .customer-name"),r=a.val(),s=getCardIdFromDataList(a),t=$("#charge-card .charge-amount"),o=parseFloat(t.val()),d=$("#charge-card .charge-invoice"),n=d.val(),c=$("#charge-card .charge-po"),l=c.val(),i=$("#charge-card .msg"),u=$("#charge-card-submit");return e.preventDefault(),MIN_CHARGE>o?(e.preventDefault(),void showPanelMessage("You must provide an amount to charge greater than the minimum charge (0.5).","danger",i)):($.ajax({type:"POST",url:"/card/charge/",data:{datastoreId:s,customerName:r,amount:o,invoice:n,po:l},beforeSend:function(){a.prop("disabled",!0),t.prop("disabled",!0),d.prop("disabled",!0),c.prop("disabled",!0),u.prop("disabled",!0),showPanelMessage("Charging card...","info",i),resetChargeSuccessPanel()},error:function(e){var a=JSON.parse(e.responseText);a.ok===!1&&(showPanelMessage(a.data.error_msg,"danger",i),console.log(a))},dataType:"json",success:function(e){var a=e.data;$("#panel-charge-success .customer-name").text(a.customer_name),$("#panel-charge-success .cardholder").text(a.cardholder_name),$("#panel-charge-success .card-last4").text(a.card_last4),$("#panel-charge-success .card-exp").text(a.card_expiration),$("#panel-charge-success .amount").text(a.amount),$("#panel-charge-success .invoice").text(a.invoice),$("#panel-charge-success .po").text(a.po);var r="/card/receipt/?chg_id="+a.charge_id;$("#show-receipt").attr("href",r);var s=$("#action-panels-container").outerWidth(),t=$("#panel-charge-card"),o=$("#panel-charge-success"),d=$(".action-btn");d.attr("disabled",!0).children("input").attr("disabled",!0),t.toggle("slide",{distance:s},600,function(){t.removeClass("show"),o.toggle("slide",600,function(){o.addClass("show"),d.attr("disabled",!1)})}),d.removeClass("active"),resetChargeCardPanel(!0)}}),!1)}),$("#charge-card").on("click",".clear-form-btn",function(){resetChargeCardPanel(!0)}),$("#reports").submit(function(e){{var a=$("#reports .customer-name"),r=(a.val(),getCardIdFromDataList(a),$("#reports .start-date").val()),s=$("#reports .end-date").val(),t=$("#reports .msg");$("#reports-submit")}if(t.html(""),""===r)return e.preventDefault(),void showPanelMessage("You must choose a Start Date.","danger",t);if(""===s)return e.preventDefault(),void showPanelMessage("You must choose an End Date.","danger",t);if(r>s)return e.preventDefault(),void showPanelMessage("The Start Date must be before the End Date.","danger",t);var o=new Date,d=o.getTimezoneOffset()/60*-1;$("#timezone").val(d);var a=$("#reports .customer-name"),n=getCardIdFromDataList(a);$("#report-customer-id").val(n)}),$("#report-rows").on("click",".refund",function(){var e=$(this),a=e.parent().siblings("td.amount-dollars").children(".amount").text(),r=e.data("chgid"),s=$("#refund-amount");s.val(a).attr("max",a),$("#refund-chg-id").val(r)}),$("#form-refund").submit(function(e){var a=$("#refund-chg-id").val(),r=$("#refund-amount").val(),s=$("#refund-reason").val(),t=$("#form-refund .msg"),o=$("#refund-submit");return t.html(""),0===a.length?(e.preventDefault(),void showModalMessage("A charge ID was not submitted.  Please refresh your browser and try again.","danger",t)):0===r.length||parseFloat(r)<0?(e.preventDefault(),void showModalMessage("You must provide an amount to refund that is greater than zero but less than the amount charged.","danger",t)):(e.preventDefault(),$.ajax({type:"POST",url:"/card/refund/",data:{chargeId:a,amount:r,reason:s},beforeSend:function(){showModalMessage("Refunding charge...","info",t),o.prop("disabled",!0)},error:function(e){var a=JSON.parse(e.responseText);a.ok===!1&&(showModalMessage(a.data.error_msg,"danger",t),o.prop("disabled",!1),console.log(a))},dataType:"json",success:function(){showModalMessage("Refund successful!","success",t),o.prop("disabled",!1),$("#refund-amount").val(""),$("#refund-reason").val("0")}}),!1)});