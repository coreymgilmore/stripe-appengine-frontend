const MIN_PASSWORD_LENGTH=8;const BAD_PASSWORDS=["password","password1","12345678","123456789","123123123","00000000","1234567890","asdfasdf","asdfghjkl","testtest","admin@example.com"];const MIN_CHARGE=0.5;const MAX_STATEMENT_DESCRIPTOR_LENGTH=22;function validateEmail(email){var regex=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return regex.test(email)}
function doWordsMatch(word1,word2){if(word1===word2){return!0}
return!1}
function isLongPassword(password){if(password.length<MIN_PASSWORD_LENGTH){return!1}
return!0}
function isSimplePassword(password){if(BAD_PASSWORDS.indexOf(password)!==-1){return!0}
return!1}
function showPanelMessage(msg,type,elem){elem.html('<div class="alert alert-'+type+'">'+msg+'</div>');return}
function showModalMessage(msg,type,elem){elem.html('<div class="alert alert-'+type+'">'+msg+'</div>');return}
$('body').on('click','.action-btn',function(){const PANEL_TRANSITION_SPEED='fast';var dataAction=$(this).data("action");var panelToShow=$('#'+dataAction);if(panelToShow.hasClass('show')){return}
var panelToHide=$('.action-panels.show');panelToHide.fadeOut(PANEL_TRANSITION_SPEED,function(){panelToHide.removeClass('show');panelToShow.fadeIn(PANEL_TRANSITION_SPEED,function(){panelToShow.addClass('show');return});return});resetAddCardPanel();resetChargeCardPanel(!0)});$('#create-init-admin').submit(function(e){var pass1=$('#password1').val();var pass2=$('#password2').val();var msg=$('#create-init-admin .msg');if(doWordsMatch(pass1,pass2)===!1){e.preventDefault();showPanelMessage("The passwords do not match.",'danger',msg);return!1}
if(isLongPassword(pass1)===!1){e.preventDefault();showPanelMessage("Your password is too short. It must be at least "+MIN_PASSWORD_LENGTH+" characters.",'danger',msg);return!1}
if(isSimplePassword(pass1)===!0){e.preventDefault();essage("The password you provided is too simple. Please choose a better password.",'danger',msg);return!1}});$(function(){$('[data-toggle="tooltip"]').tooltip();$.ajaxSetup({dataType:'json'});return});function getCards(){var customerList=$('#customer-list');$.ajax({type:"GET",url:"/card/get/all/",beforeSend:function(){console.log("Loading cards...");customerList.html('<option value="Loading...">');return},error:function(r){customerList.html('<option value="Could Not Load">');return},success:function(j){console.log("Loading cards...done!")
var data=j.data;customerList.html('');if(data===null||data.length===0){customerList.html('<option value="None exist yet!" data-id="0">');return}
data.forEach(function(elem,index){var name=elem.customer_name;var id=elem.id;customerList.append('<option value="'+name+'" data-id="'+id+'">')});return}})}
function getCardIdFromDataList(autocompleteElement){var selectedOptionValue=autocompleteElement.val();var options=$('#customer-list option');var id="";options.each(function(){var elemValue=$(this).val();var elemId=$(this).data('id');if(selectedOptionValue===elemValue){id=elemId;return!1}});return id}
function generateExpirationYears(){console.log("Loading expiration years...");var elem=$('#card-exp-year');elem.html('');var d=new Date()
var year=d.getFullYear();elem.append('<option value="0">Please choose.</option>');for(var i=year;i<year+11;i ++){elem.append('<option value='+i+'>'+i+'</option>')}
console.log('Loading expiration years...done!');return}
function getUsers(){var userList=$('.user-list');$.ajax({type:"GET",url:"/users/get/all/",beforeSend:function(){userList.html('<option value="0">Loading...</option>').attr('disabled',!0);return},error:function(r){userList.html('<option value="0">Error (please see dev tools)</option>');return},success:function(r){userList.html('');userList.append("<option value='0'>Please choose...</option>").attr('disabled',!1);var users=r.data;users.forEach(function(u,index){if(u.username==="administrator"){return}
userList.append('<option value="'+u.id+'">'+u.username+'</option>');return});return}})}
$('#form-new-user').submit(function(e){var username=$('#form-new-user .username').val();var password1=$('#form-new-user .password1').val();var password2=$('#form-new-user .password2').val();var addCards=$('#form-new-user .can-add-cards input:checked').val();var removeCards=$('#form-new-user .can-remove-cards input:checked').val();var chargeCards=$('#form-new-user .can-charge-cards input:checked').val();var reports=$('#form-new-user .can-view-reports input:checked').val();var admin=$('#form-new-user .is-admin input:checked').val();var active=$('#form-new-user .is-active input:checked').val();var msgElem=$('#form-new-user .msg');var submit=$('#form-new-user-submit');if(validateEmail(username)===!1){e.preventDefault();showModalMessage('You must provide an email address as a username.','danger',msgElem);return!1}
if(doWordsMatch(password1,password2)===!1){e.preventDefault();showModalMessage('The passwords do not match.','danger',msgElem);return!1}
if(isLongPassword(password1)===!1){e.preventDefault();showModalMessage('Your password is too short. It must be at least '+MIN_PASSWORD_LENGTH+' characters.','danger',msgElem);return!1}
if(isSimplePassword(password1)===!0){e.preventDefault();showModalMessage('Your password too simple. Choose a more complex password.','danger',msgElem);return!1}
msgElem.html('');e.preventDefault();$.ajax({type:'POST',url:'/users/add/',data:{username:username,password1:password1,password2:password2,addCards:addCards,removeCards:removeCards,chargeCards:chargeCards,reports:reports,admin:admin,active:active},beforeSend:function(){submit.attr("disabled",!0);showModalMessage("Saving user...","info",msgElem);return},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){showModalMessage(j.data.error_msg,'danger',msgElem);return}
submit.attr("disabled",!1);return},success:function(r){showModalMessage("New user was saved sucessfully!","success",msgElem);setTimeout(function(){submit.attr("disabled",!1);resetAddUserModal()},3000)}});return!1});function resetAddUserModal(){$('#form-new-user .username, #form-new-user .password1, #form-new-user .password2').val('');$('#form-new-user .default').attr("checked",!0).parent('label').addClass('active').siblings('label').removeClass('active')
$('.msg').html('');return}
$('#modal-new-user').on('hidden.bs.modal',function(){resetAddUserModal();return});$('#modal-change-pwd, #modal-update-user').on('show.bs.modal',function(){getUsers()
return});$('#form-change-pwd').submit(function(e){var id=$('#form-change-pwd .user-list').val();var pass1=$('#form-change-pwd .password1').val();var pass2=$('#form-change-pwd .password2').val();var msgElem=$('#form-change-pwd .msg');var submit=$('#change-password-submit');if(doWordsMatch(pass1,pass2)===!1){e.preventDefault();showModalMessage("The passwords do not match.","danger",msgElem);return!1}
if(isLongPassword(pass1)===!1){e.preventDefault();showModalMessage("Your password is too short. It must be at least "+MIN_PASSWORD_LENGTH+" characters.","danger",msgElem);return!1}
if(isSimplePassword(pass1)===!0){e.preventDefault();showModalMessage("Your password too simple. Choose a more complex password.","danger",msgElem);return!1}
$.ajax({type:"POST",url:"/users/change-pwd/",data:{userId:id,pass1:pass1,pass2:pass2},beforeSend:function(){submit.attr("disabled",!0);showModalMessage("Saving new password...","info",msgElem);return},error:function(r){showModalMessage("An error occured while trying to update this user's password.","danger",msgElem);return},success:function(r){showModalMessage("This user's password has been updated.","success",msgElem);setTimeout(function(){submit.attr("disabled",!1);resetChangePwdModal()},3000)}});e.preventDefault();return!1});function resetChangePwdModal(){$('.user-list').val('0');$('#form-change-pwd .password1').val('');$('#form-change-pwd .password2').val('');$('.msg').html('');return}
$('#modal-change-pwd').on('hidden.bs.modal',function(){resetAddUserModal();return});function resetUpdateUserModal(){$('#form-update-user label.btn').attr('disabled',!0).removeClass('active');$('#form-update-user input[type=radio]').attr('disabled',!0).attr('checked',!1);$('.msg').html('');$('#update-user-submit').attr('disabled',!0);return}
$('#modal-update-user').on('hidden.bs.modal',function(){resetUpdateUserModal();return});$('#form-update-user').on('change','.user-list',function(){var userId=$(this).val();var msgElem=$('#form-update-user .msg');if(userId===0){resetUpdateUserModal();return}
$.ajax({type:"GET",url:"/users/get/",data:{userId:userId},beforeSend:function(){resetUpdateUserModal();showModalMessage("Retrieving user's permissions...","info",msgElem);return},error:function(r){showModalMessage("An error occured while trying to retrieve this users data. Please try again.","danger",msgElem);return},success:function(j){msgElem.html('');$('#form-update-user label.btn').attr('disabled',!1);$('#form-update-user input[type=radio]').attr('disabled',!1);$('#update-user-submit').attr('disabled',!1);var data=j.data
if(data.add_cards){$('#form-update-user .can-add-cards input[value=true]').attr('checked',!0).parent().addClass('active')}
else{$('#form-update-user .can-add-cards input[value=false]').attr('checked',!0).parent().addClass('active')}
if(data.remove_cards){$('#form-update-user .can-remove-cards input[value=true]').attr('checked',!0).parent().addClass('active')}
else{$('#form-update-user .can-remove-cards input[value=false]').attr('checked',!0).parent().addClass('active')}
if(data.charge_cards){$('#form-update-user .can-charge-cards input[value=true]').attr('checked',!0).parent().addClass('active')}
else{$('#form-update-user .can-charge-cards input[value=false]').attr('checked',!0).parent().addClass('active')}
if(data.view_reports){$('#form-update-user .can-view-reports input[value=true]').attr('checked',!0).parent().addClass('active')}
else{$('#form-update-user .can-view-reports input[value=false]').attr('checked',!0).parent().addClass('active')}
if(data.is_admin){$('#form-update-user .is-admin input[value=true]').attr('checked',!0).parent().addClass('active')}
else{$('#form-update-user .is-admin input[value=false]').attr('checked',!0).parent().addClass('active')}
if(data.is_active){$('#form-update-user .is-active input[value=true]').attr('checked',!0).parent().addClass('active')}
else{$('#form-update-user .is-active input[value=false]').attr('checked',!0).parent().addClass('active')}
return}});return});$('#form-update-user').submit(function(e){var userId=$('#form-update-user .user-list').val();var addCards=$('#form-update-user .can-add-cards label.active input').val();var removeCards=$('#form-update-user .can-remove-cards label.active input').val();var chargeCards=$('#form-update-user .can-charge-cards label.active input').val();var reports=$('#form-update-user .can-view-reports label.active input').val();var admin=$('#form-update-user .is-admin label.active input').val();var active=$('#form-update-user .is-active label.active input').val();var msgElem=$('#form-update-user .msg');var submit=$('#update-user-submit');if(userId.length===0){e.preventDefault();showModalMessage("A user must be chosen first.","danger",msgElem);return}
e.preventDefault();$.ajax({type:"POST",url:"/users/update/",data:{userId:userId,addCards:addCards,removeCards:removeCards,chargeCards:chargeCards,reports:reports,admin:admin,active:active},beforeSend:function(){submit.attr('disabled',!0);showModalMessage("Saving updated permissions...","info",msgElem);return},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){showModalMessage(j.data.error_msg,'danger',msgElem);return}
return},success:function(j){showModalMessage("User updated successfully!","success",msgElem);setTimeout(function(){submit.attr('disabled',!1);msgElem.html('')},3000);return}});return!1});$('#add-card').on('change','#card-exp-month',function(){var expMonth=$(this).val();var d=new Date();var currentMonth=d.getMonth()+1;var currentYear=d.getFullYear();if(expMonth<currentMonth){$('#card-exp-year option[value='+currentYear+']').css({"display":"none"})}
else{$('#card-exp-year option[value='+currentYear+']').css({"display":"block"})}
return});$('#add-card').submit(function(e){var form=$('#add-card');var customerId=$('#customer-id').val().trim();var customerName=$('#customer-name').val().trim();var cardholder=$('#cardholder-name').val().trim();var cardNum=$('#card-number').val().trim().replace(' ','').replace('-','');var expYear=parseInt($('#card-exp-year').val());var expMonth=parseInt($('#card-exp-month').val());var cvc=$('#card-cvc').val().trim();var postal=$('#card-postal-code').val().trim();var cardType=Stripe.card.cardType(cardNum);var submitBtn=$('#add-card .submit-form-btn');var msg=$('#add-card .msg');msg.html('');if(customerName.length<2){e.preventDefault();showPanelMessage('You must provide a customer name. This can be the same as the cardholder or the name of a company. This is used to lookup cards when you want to create a charge.',"danger",msg);return!1}
if(cardholder.length<2){e.preventDefault();showPanelMessage('Please provide the name of the cardholder as it is given on the card.','danger',msg);return!1}
var cardNumLength=cardNum.length;if(cardNumLength<14||cardNumLength>16){e.preventDefault();showPanelMessage('The card number you provided is '+cardNumLength+' digits long, however, it must be exactly 15 or 16 digits.','danger',msg);return!1}
if(Stripe.card.validateCardNumber(cardNum)===!1){e.preventDefault();showPanelMessage('The card number you provided is not valid.','danger',msg);return!1}
var d=new Date();var nowMonth=d.getMonth()+1;var nowYear=d.getFullYear();if(expMonth===0||expMonth==='0'){e.preventDefault();showPanelMessage('Please choose the card\'s expiration month.','danger',msg);return!1}
if(expYear===0||expYear==='0'){e.preventDefault();showPanelMessage('Please choose the card\'s expiration year.','danger',msg);return!1}
if(expYear===nowYear&&expMonth<nowMonth){e.preventDefault();showPanelMessage('The card\'s expiration must be in the future.','danger',msg);return!1}
if(Stripe.card.validateExpiry(expMonth,expYear)===!1){e.preventDefault();showPanelMessage('The card\'s expiration must be in the future.','danger',msg);return!1}
if(Stripe.card.validateCVC(cvc)===!1){e.preventDefault();showPanelMessage('The security code you provided is invalid.','danger',msg);return!1}
if(cardType==="American Express"&&cvc.length!==4){e.preventDefault();showPanelMessage('You provided an American Express card but your security code is invalid. The security code must be exactly 4 numbers long.','danger',msg);return!1}
if(cardType!=="American Express"&&cvc.length!==3){e.preventDefault();showPanelMessage('You provided an '+Stripe.card.cardType(cardNum)+' card but your security code is invalid. The security code must be exactly 3 numbers long.','danger',msg);return!1}
if(postal.length<5||postal.length>6){e.preventDefault();showPanelMessage('The postal code must be exactly 5 numeric or 6 alphanumeric characters.','danger',msg);return!1}
submitBtn.prop("disabled",!0);showPanelMessage('Saving card...','info',msg);Stripe.card.createToken({name:cardholder,number:cardNum,cvc:cvc,exp_month:expMonth,exp_year:expYear,address_zip:postal},createTokenCallback)
function createTokenCallback(status,response){if(response.error){showPanelMessage('The credit card could not be saved. Please contact an administrator. Message: '+response.error.message+'.','danger',msg);return}
$.ajax({type:"POST",url:"/card/add/",data:{customerId:customerId,customerName:customerName,cardholder:cardholder,cardToken:response.id,cardExp:response.card.exp_month+"/"+response.card.exp_year,cardLast4:response.card.last4},error:function(r){var j=JSON.parse(r.responseText);if(j.ok==!1){showPanelMessage(j.data.error_msg,'danger',msg);submitBtn.prop("disabled",!1).text("Add Card");return}
return},success:function(r){resetAddCardPanel();showPanelMessage("Card was saved!",'success',msg);setTimeout(function(){msg.html('');submitBtn.prop("disabled",!1).text("Add Card");getCards()},2000);return}});return}
e.preventDefault();return!1});function resetAddCardPanel(){$('#customer-id').val('');$('#customer-name').val('');$('#cardholder-name').val('');$('#card-number').val('');$('#card-exp-year').val('0');$('#card-exp-month').val('0');$('#card-cvc').val('');$('#card-postal-code').val('');return}
$('#panel-add-card').on('click','.clear-form-btn',function(){resetAddCardPanel();$('#add-card .msg').html('');return});$('#remove-card').submit(function(e){var input=$('#remove-card .customer-name');var custName=input.val();var custId=getCardIdFromDataList(input);var btn=$('#remove-card .submit-form-btn');var msg=$('#remove-card .msg');if(custId===0||custId==="0"||custId.length===0){e.preventDefault();showPanelMessage("You must choose a customer.","danger",msg);return}
$.ajax({type:"POST",url:"/card/remove/",data:{customerId:custId,customerName:custName},beforeSend:function(){btn.prop('disabled',!0);showPanelMessage('Removing card...','info',msg);return},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){btn.prop('disabled',!1);showPanelMessage('An error occured while removing this card. Do not refresh or leave this screen! Please contact an administrator.','danger',msg)}
return},success:function(j){btn.prop('disabled',!1);showPanelMessage('Card was removed!','success',msg);input.val('');setTimeout(function(){msg.html('');getCards()},2000);return}});e.preventDefault();return!1});$('#charge-card').on('change','.customer-name',function(){var input=$('#charge-card .customer-name');var custId=getCardIdFromDataList(input);var msg=$('#charge-card .msg');msg.html('');if(custId===""){showPanelMessage("The customer name you provided is not a real customer. Please choose a customer from the list.","danger",msg);return}
$.ajax({type:"GET",url:"/card/get/",data:{customerId:custId},beforeSend:function(){$('#charge-card .customer-cardholder, #charge-card .card-last-four, #charge-card .card-expiration').val("Loading...");return},error:function(r){var j=JSON.parse(r.responseText);showPanelMessage(j.data.error_msg,"danger",msg);return},success:function(j){var data=j.data;$('#charge-card .customer-cardholder').val(data.cardholder_name);$('#charge-card .card-last-four').val(data.card_last4);$('#charge-card .card-expiration').val(data.card_expiration);$('#charge-card .charge-amount, #charge-card .charge-invoice, #charge-card .charge-po').prop('disabled',!1);return}});return});$('#charge-card').submit(function(e){var customerNameInput=$('#charge-card .customer-name');var customerName=customerNameInput.val();var datastoreId=getCardIdFromDataList(customerNameInput);var amountElem=$('#charge-card .charge-amount');var amount=parseFloat(amountElem.val());var invoiceElem=$('#charge-card .charge-invoice');var invoice=invoiceElem.val();var poElem=$('#charge-card .charge-po');var po=poElem.val();var msg=$('#charge-card .msg');var btn=$('#charge-card-submit');var dropdownBtn=btn.siblings('.dropdown-toggle');var chargeAndRemove=btn.data("chargeandremove")||!1;e.preventDefault();if(amount<MIN_CHARGE){e.preventDefault();showPanelMessage("You must provide an amount to charge greater than the minimum charge ("+MIN_CHARGE+").","danger",msg);return}
btn.data("chargeandremove","");$.ajax({type:"POST",url:"/card/charge/",data:{datastoreId:datastoreId,customerName:customerName,amount:amount,invoice:invoice,po:po,chargeAndRemove:chargeAndRemove},beforeSend:function(){customerNameInput.prop('disabled',!0);amountElem.prop('disabled',!0);invoiceElem.prop('disabled',!0);poElem.prop('disabled',!0);btn.prop('disabled',!0);dropdownBtn.prop('disabled',!0);showPanelMessage("Charging card...",'info',msg);resetChargeSuccessPanel();return},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){showPanelMessage(j.data.error_msg,'danger',msg)}
return},success:function(j){var data=j.data;$('#panel-charge-success .customer-name').text(data.customer_name);$('#panel-charge-success .cardholder').text(data.cardholder_name);$('#panel-charge-success .card-last4').text(data.card_last4);$('#panel-charge-success .card-exp').text(data.card_expiration);$('#panel-charge-success .amount').text("$"+parseFloat(data.amount).toFixed(2));$('#panel-charge-success .invoice').text(data.invoice);$('#panel-charge-success .po').text(data.po);var href="/card/receipt/?chg_id="+data.charge_id;$('#show-receipt').attr('href',href);var containerWidth=$('#action-panels-container').outerWidth()
var chargeCardPanel=$('#panel-charge-card');var successPanel=$('#panel-charge-success');var allBtns=$('.action-btn');allBtns.attr("disabled",!0).children("input").attr("disabled",!0);chargeCardPanel.fadeOut(200,function(){chargeCardPanel.removeClass("show");successPanel.fadeIn(200,function(){successPanel.addClass("show");allBtns.attr("disabled",!1).children("input").attr("disabled",!1)})});allBtns.removeClass('active');resetChargeCardPanel(!0);if(chargeAndRemove){setTimeout(function(){getCards()},2000)}
return}});return!1});$('.dropdown-menu.charge-card-options').on('click','#charge-and-remove-card',function(){$('#charge-card-submit').data("chargeandremove",!0);$('#charge-card').submit();return});function resetChargeCardPanel(msgRemove){$('#charge-card .customer-name').val('').prop('disabled',!1);$('#charge-card .customer-cardholder').val('');$('#charge-card .card-last-four').val('');$('#charge-card .card-expiration').val('');$('#charge-card .charge-amount').val('');$('#charge-card .charge-invoice').val('');$('#charge-card .charge-po').val('');$('#charge-card-submit').prop('disabled',!1);$('#charge-card-submit').siblings('.dropdown-toggle').prop('disabled',!1);$('#charge-card .charge-amount, #charge-card .charge-invoice, #charge-card .charge-po').prop('disabled',!0);if(msgRemove){$('#charge-card .msg').html('')}
return}
$('#panel-charge-card').on('click','.clear-form-btn',function(){resetChargeCardPanel(!0);return});function resetChargeSuccessPanel(){$('#panel-charge-success .customer-name').text('');$('#panel-charge-success .cardholder').text('');$('#panel-charge-success .card-last4').text('');$('#panel-charge-success .card-exp').text('');$('#panel-charge-success .amount').text('');$('#panel-charge-success .invoice').text('');$('#panel-charge-success .po').text('');$('#show-receipt').attr('href','');return}
$('#reports').submit(function(e){var customerNameInput=$('#reports .customer-name');var customerName=customerNameInput.val();var customerId=getCardIdFromDataList(customerNameInput);var startDate=$('#reports .start-date').val();var endDate=$('#reports .end-date').val()
var msg=$('#reports .msg');var btn=$('#reports-submit');msg.html('');if(startDate===""){e.preventDefault();showPanelMessage("You must choose a Start Date.","danger",msg);return}
if(endDate===""){e.preventDefault();showPanelMessage("You must choose an End Date.","danger",msg);return}
if(endDate<startDate){e.preventDefault();showPanelMessage("The Start Date must be before the End Date.","danger",msg);return}
var d=new Date();var offset=(d.getTimezoneOffset()/60)*-1;$('#timezone').val(offset);var customerNameInput=$('#reports .customer-name');var datastoreId=getCardIdFromDataList(customerNameInput);$('#report-customer-id').val(datastoreId);return});$('#report-rows').on('click','.refund',function(){var refundBtn=$(this);var amountDollars=parseFloat(refundBtn.parent().siblings('td.amount-dollars').children('.amount').text().replace(",","")).toFixed(2);var chargeId=refundBtn.data("chgid");var refundAmount=$('#refund-amount');refundAmount.val(amountDollars).attr("max",amountDollars);$('#refund-chg-id').val(chargeId);return});$('#form-refund').submit(function(e){var chargeId=$('#refund-chg-id').val();var amount=$('#refund-amount').val();var reason=$('#refund-reason').val();var msg=$('#form-refund .msg');var btn=$('#refund-submit');msg.html('');if(chargeId.length===0){e.preventDefault();showModalMessage("A charge ID was not submitted.  Please refresh your browser and try again.","danger",msg);return}
if(amount.length===0||parseFloat(amount)<0){e.preventDefault();showModalMessage("You must provide an amount to refund that is greater than zero but less than the amount charged.","danger",msg);return}
e.preventDefault();$.ajax({type:"POST",url:"/card/refund/",data:{chargeId:chargeId,amount:amount,reason:reason},beforeSend:function(){showModalMessage("Refunding charge...","info",msg);btn.prop('disabled',!0);return},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){showModalMessage(j.data.error_msg,'danger',msg);btn.prop('disabled',!1)}
return},success:function(j){showModalMessage("Refund successful!","success",msg);btn.prop('disabled',!1);$('#refund-amount').val("");$('#refund-reason').val("0");return}})
return!1});$('#modal-change-company-info').on('show.bs.modal',function(){var msg=$('#modal-change-company-info .msg');$.ajax({type:"GET",url:"/company/get/",beforeSend:function(){showModalMessage("Loading company information...","info",msg);return},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){if(j.data.error_type==="companyInfoDoesNotExist"){showModalMessage("You do have any company info set. Your recipts will show up blank without setting the fields above.","info",msg);return;$('#company-info-submit').prop('disabled',!1);return}
showModalMessage("An error occured and your company data could not be loaded.  Please try again.","danger",msg);$('#company-info-submit').prop('disabled',!0);return}},success:function(j){var data=j.data;$('#modal-change-company-info .company-name').val(data.company_name);$('#modal-change-company-info .company-street').val(data.street);$('#modal-change-company-info .company-suite').val(data.suite);$('#modal-change-company-info .company-city').val(data.city);$('#modal-change-company-info .company-state').val(data.state);$('#modal-change-company-info .company-postal').val(data.postal_code);$('#modal-change-company-info .company-country').val(data.country);$('#modal-change-company-info .company-phone').val(data.phone_num);$('#modal-change-company-info .company-email').val(data.email);$('#modal-change-company-info .percentage-fee').val(parseFloat(data.percentage_fee*100).toFixed(2));$('#modal-change-company-info .fixed-fee').val(data.fixed_fee.toFixed(2));$('#modal-change-company-info .statement-descriptor').val(data.statement_descriptor);msg.html('');$('#company-info-submit').prop('disabled',!1);return}});return});$('#modal-change-company-info').on('hidden.bs.modal',function(){$('#modal-change-company-info .msg').html('');$('#company-info-submit').prop('disabled',!0);$('#modal-change-company-info input').val('');return});$('#form-change-company-info').submit(function(e){e.preventDefault();var name=$('#modal-change-company-info .company-name').val();var street=$('#modal-change-company-info .company-street').val();var suite=$('#modal-change-company-info .company-suite').val();var city=$('#modal-change-company-info .company-city').val();var state=$('#modal-change-company-info .company-state').val();var postal=$('#modal-change-company-info .company-postal').val();var country=$('#modal-change-company-info .company-country').val();var phone=$('#modal-change-company-info .company-phone').val();var email=$('#modal-change-company-info .company-email').val();var percentFee=parseFloat($('#modal-change-company-info .percentage-fee').val());var fixedFee=parseFloat($('#modal-change-company-info .fixed-fee').val());var descriptor=$('#modal-change-company-info .statement-descriptor').val();var msg=$('#modal-change-company-info .msg');var btn=$('#company-info-submit');if(state.length>2){showModalMessage("State must be a two character abbreviation.","danger",msg);return}
if(postal.length>6){showModalMessage("Postal code must be 5 or 6 alphanumeric characters.","danger",msg);return}
if(country.length>3){showModalMessage("Country must be a 2 or 3 character abbreviation.","danger",msg);return}
if(percentFee<0||percentFee>100||isNaN(percentFee)){showModalMessage("Percentage fee must be a number such as 2.95.","danger",msg);return}
if(fixedFee<0||fixedFee>100||isNaN(fixedFee)){showModalMessage("Fixed fee must be a number such as 0.30.","danger",msg);return}
if(descriptor.length<5||descriptor.length>22){showModalMessage("Statement descriptor must be between 5 and 22 characters long.  It is currently "+descriptor.length+" characters.","danger",msg);return}
$.ajax({type:"POST",url:"/company/set/",data:{name:name,street:street,suite:suite,city:city,state:state,postal:postal,country:country,phone:phone,email:email,percentFee:percentFee,fixedFee:fixedFee,descriptor:descriptor,},beforeSend:function(){showModalMessage("Saving company information...","info",msg);btn.prop("disabled",!0)},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){showModalMessage("An error occured and your company info could not be saved.","danger",msg);return}},success:function(j){showModalMessage("Company information was saved!","success",msg);btn.prop('disabled',!1);setTimeout(function(){msg.html('');return},3000);return}});return!1});$('#modal-app-settings').on('show.bs.modal',function(){var msg=$('#modal-app-settings .msg');$.ajax({type:"GET",url:"/app-settings/get/",beforeSend:function(){showModalMessage("Loading app settings...","info",msg);return},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){showModalMessage("An error occured and your app settings could not be loaded.  Please try again.","danger",msg);$('#app-settings-submit').prop('disabled',!0);return}},success:function(j){var data=j.data;if(data.require_cust_id){$('#form-change-app-settings .require-cust-id input[value=true]').attr('checked',!0).parent().addClass('active')}
else{$('#form-change-app-settings .require-cust-id input[value=false]').attr('checked',!0).parent().addClass('active')}
$('#modal-app-settings .cust-id-format').val(data.cust_id_format);msg.html('');$('#app-settings-submit').prop('disabled',!1);return}});return});$('#modal-app-settings').on('hidden.bs.modal',function(){$('#modal-app-settings .msg').html('');$('#app-settings-submit').prop('disabled',!0);$('#modal-app-settings input').val('');return});$('#form-change-app-settings').submit(function(e){e.preventDefault();var requireCustID=$('#modal-app-settings .require-cust-id label.active input').val();var custIDFormat=$('#modal-app-settings .cust-id-format').val();var msg=$('#modal-app-settings .msg');var btn=$('#app-settings-submit');$.ajax({type:"POST",url:"/app-settings/set/",data:{requireCustID:requireCustID,custIDFormat:custIDFormat,},beforeSend:function(){showModalMessage("Saving app settings...","info",msg);btn.prop("disabled",!0)},error:function(r){var j=JSON.parse(r.responseText);if(j.ok===!1){showModalMessage("An error occured and your app settings could not be saved.","danger",msg);return}},success:function(j){showModalMessage("App settings saved! Refresh the app to see the changes applied.","success",msg);btn.prop('disabled',!1);setTimeout(function(){msg.html('');return},5000);return}});return!1})